<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>–ú–æ–Ω–æ–ø–æ–ª–∏—è ‚Äî —Å–µ–º–µ–π–Ω–∞—è –≤–µ—Ä—Å–∏—è (–ø—Ä–æ—Ç–æ—Ç–∏–ø)</title>
  <style>
    :root{
      --bg:#0f172a; /* slate-900 */
      --panel:#111827; /* gray-900 */
      --muted:#334155; /* slate-600 */
      --text:#e5e7eb; /* gray-200 */
      --accent:#f59e0b; /* amber-500 */
      --ok:#22c55e; /* green-500 */
      --bad:#ef4444; /* red-500 */
    }
    html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,sans-serif}
    .app{display:grid;grid-template-columns: 1fr 360px;gap:16px;height:100%;padding:16px;box-sizing:border-box}
    .board-wrap{display:grid;place-items:center;background:linear-gradient(180deg,#0b1225,#0a0f1f);border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.35);position:relative}

    /* 11x11 CSS Grid –ø–æ –ø–µ—Ä–∏–º–µ—Ç—Ä—É 40 –∫–ª–µ—Ç–æ–∫ */
    .board{width:min(92vmin,1200px);height:min(92vmin,1200px);display:grid;grid-template-columns:repeat(11,1fr);grid-template-rows:repeat(11,1fr);gap:4px;padding:8px;box-sizing:border-box}
    .cell{background:#111827;border:1px solid #1f2937;border-radius:8px;display:flex;align-items:center;justify-content:center;text-align:center;padding:4px;font-size:clamp(8px,1.2vmin,14px);position:relative}
    .cell .price{position:absolute;bottom:4px;right:6px;font-size:.8em;color:#94a3b8}
    .center{grid-area: 2 / 2 / span 9 / span 9;border-radius:16px;background:radial-gradient(ellipse at center,#0c1328 0%, #0a0f1f 60%, #0a0f1f 100%);display:grid;place-items:center;position:relative}

    /* –ö–æ—Å—Ç–∏ –≤ —Ü–µ–Ω—Ç—Ä–µ */
    .dice-wrap{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;gap:14px;pointer-events:none}
    .die{width:min(9vmin,72px);height:min(9vmin,72px);border-radius:18px;background:linear-gradient(145deg,#0e162d,#0b1225);border:1px solid #1f2937;display:flex;align-items:center;justify-content:center;font-weight:900;font-size:calc(min(9vmin,72px)*0.5);box-shadow:inset 0 4px 12px rgba(0,0,0,.5),0 6px 18px rgba(0,0,0,.35);opacity:.85;transform:translateZ(0)}
    .die.shake{animation:shake .4s ease both}
    @keyframes shake{0%{transform:rotate(0) scale(1)}25%{transform:rotate(8deg) scale(1.05)}50%{transform:rotate(-8deg) scale(1.05)}75%{transform:rotate(6deg)}100%{transform:rotate(0) scale(1)}}

    /* –ü–∞–Ω–µ–ª—å —Å–ø—Ä–∞–≤–∞ */
    .side{background:var(--panel);border:1px solid #1f2937;border-radius:16px;display:grid;grid-template-rows:auto auto 1fr auto;overflow:hidden}
    .bar{display:flex;gap:8px;padding:12px;border-bottom:1px solid #1f2937;align-items:center}
    button{background:#1f2937;color:var(--text);border:1px solid #334155;border-radius:10px;padding:10px 12px;font-weight:600;cursor:pointer}
    button:hover{border-color:#475569}
    .big{font-size:18px;padding:14px 16px}
    .row{display:flex;gap:8px;flex-wrap:wrap}
    .log{padding:12px;overflow:auto;font-size:14px}
    .log p{margin:.3em 0}
    .players{padding:12px;border-top:1px solid #1f2937;display:grid;gap:10px}
    .player{display:flex;justify-content:space-between;align-items:center;background:#0b1222;border:1px solid #1f2937;border-radius:12px;padding:10px}
    .money{font-weight:700}

    /* –§–∏—à–∫–∏ (–±–æ–ª—å—à–∏–µ —Å–∫—Ä—ã—Ç—ã) */
    .tokens{position:absolute;inset:8px;pointer-events:none;display:none}
    .token{display:none}
    .t0{background:#60a5fa}
    .t1{background:#fca5a5}
    .t2{background:#86efac}
    .t3{background:#fcd34d}

    /* –ú–∞–ª–µ–Ω—å–∫–∏–µ –ø–∏–ø–∫–∏-–ø–æ–∑–∏—Ü–∏–∏ –Ω–∞ –∫–ª–µ—Ç–∫–∞—Ö */
    .pips{position:absolute;bottom:4px;left:6px;display:flex;gap:4px}
    .pip{width:10px;height:10px;border-radius:50%;border:1px solid rgba(255,255,255,.7);box-shadow:0 1px 2px rgba(0,0,0,.4)}

    .toast{position:absolute;left:50%;bottom:18px;transform:translateX(-50%);background:#111827;border:1px solid #334155;border-radius:12px;padding:10px 14px;font-weight:700;opacity:0;transition:opacity .25s}
    .toast.show{opacity:1}

    /* –ö–Ω–æ–ø–∫–∏ –≤–Ω–∏–∑—É –ø–∞–Ω–µ–ª–∏ */
    .ui{display:grid;grid-template-columns:1fr 1fr;gap:8px;padding:12px;border-top:1px solid #1f2937}
    .ui button{font-size:16px;padding:14px}

    /* –ü–æ–¥—Å–≤–µ—Ç–∫–∞ –∞–∫—Ç–∏–≤–Ω–æ–π –∫–ª–µ—Ç–∫–∏ */
    .cell.active{box-shadow:0 0 0 3px var(--accent) inset}

    /* –ú–∞—Ä–∫–µ—Ä—ã –≤–ª–∞–¥–µ–Ω–∏—è */
    .owner-tag{position:absolute;left:0;bottom:0;height:6px;width:100%;border-bottom-left-radius:8px;border-bottom-right-radius:8px;opacity:.95}
    .owner-chip{position:absolute;top:4px;right:4px;width:12px;height:12px;border-radius:50%;border:1px solid rgba(255,255,255,.6);box-shadow:0 1px 2px rgba(0,0,0,.4)}

    /* –ê–Ω–Ω–æ—Ç–∞—Ü–∏–∏ –ø–æ —Ü–µ–Ω—Ç—Ä—É –ø–æ–ª—è */
    .anno{position:absolute;left:50%;top:42%;transform:translate(-50%,-50%);max-width:60%;padding:16px 20px;border-radius:14px;background:rgba(17,24,39,.7);border:1px solid #475569;backdrop-filter:blur(3px);font-size:clamp(14px,2.2vmin,20px);line-height:1.4;white-space:pre-line;pointer-events:none;z-index:5;text-align:left}
    .anno .msg{margin:.25em 0;font-weight:800}
    .anno .buy{color:#22c55e}
    .anno .rent{color:#ef4444}
    .anno .info{color:#e5e7eb}
  </style>
</head>
<body>
  <div class="app">
    <div class="board-wrap">
      <div class="board" id="board"></div>
      <div class="tokens" id="tokens"></div>
      <div id="anno" class="anno" aria-live="polite"></div>
      <div class="toast" id="toast">&nbsp;</div>
    </div>

    <aside class="side">
      <div class="bar">
        <button id="newGame" class="big">–ù–æ–≤–∞—è –∏–≥—Ä–∞</button>
        <div style="flex:1"></div>
        <strong id="turnLabel">–•–æ–¥: ‚Äî</strong>
      </div>

      <div class="row" style="padding:10px">
        <button id="roll" class="big">–ë—Ä–æ—Å–∏—Ç—å –∫–æ—Å—Ç–∏ üé≤</button>
        <button id="buy">–ö—É–ø–∏—Ç—å</button>
        <button id="skipBuy">–ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å</button>
        <button id="sell">–ü—Ä–æ–¥–∞—Ç—å</button>
        <button id="build">–°—Ç—Ä–æ–∏—Ç—å</button>
      </div>

      <div class="log" id="log"></div>
      <div class="players" id="players"></div>

      <div class="ui">
        <button id="help">–ü—Ä–∞–≤–∏–ª–∞</button>
        <button id="save">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      </div>
    </aside>
  </div>

  <script>
  // ======================
  // –î–ê–ù–ù–´–ï –î–û–°–ö–ò –ò –ö–ê–†–¢
  // ======================
  const BOARD = [
    {id:0, name:"–°–¢–ê–†–¢", type:"go", payout:200},
    {id:1, name:"–ë—Ä–∞—É–Ω-1", type:"prop", color:"#8b5e3c", price:60, baseRent:2},
    {id:2, name:"–ö–∞—Å—Å–∞ —Å–æ–æ–±—â–µ—Å—Ç–≤–∞", type:"community"},
    {id:3, name:"–ë—Ä–∞—É–Ω-2", type:"prop", color:"#8b5e3c", price:60, baseRent:4},
    {id:4, name:"–ù–∞–ª–æ–≥", type:"tax", amount:200},
    {id:5, name:"–ñ/–î —Å—Ç–∞–Ω—Ü–∏—è", type:"rail", price:200},
    {id:6, name:"–ì–æ–ª—É–±–æ–π-1", type:"prop", color:"#60a5fa", price:100, baseRent:6},
    {id:7, name:"–®–∞–Ω—Å", type:"chance"},
    {id:8, name:"–ì–æ–ª—É–±–æ–π-2", type:"prop", color:"#60a5fa", price:100, baseRent:6},
    {id:9, name:"–ì–æ–ª—É–±–æ–π-3", type:"prop", color:"#60a5fa", price:120, baseRent:8},
    {id:10, name:"–¢–Æ–†–¨–ú–ê / –í –ì–û–°–¢–Ø–•", type:"jail"},
    {id:11, name:"–†–æ–∑–æ–≤—ã–π-1", type:"prop", color:"#f472b6", price:140, baseRent:10},
    {id:12, name:"–≠–ª–µ–∫—Ç—Ä–æ—Å—Ç–∞–Ω—Ü–∏—è", type:"util", price:150},
    {id:13, name:"–†–æ–∑–æ–≤—ã–π-2", type:"prop", color:"#f472b6", price:140, baseRent:10},
    {id:14, name:"–†–æ–∑–æ–≤—ã–π-3", type:"prop", color:"#f472b6", price:160, baseRent:12},
    {id:15, name:"–ñ/–î —Å—Ç–∞–Ω—Ü–∏—è", type:"rail", price:200},
    {id:16, name:"–û—Ä–∞–Ω–∂–µ–≤—ã–π-1", type:"prop", color:"#fb923c", price:180, baseRent:14},
    {id:17, name:"–ö–∞—Å—Å–∞ —Å–æ–æ–±—â–µ—Å—Ç–≤–∞", type:"community"},
    {id:18, name:"–û—Ä–∞–Ω–∂–µ–≤—ã–π-2", type:"prop", color:"#fb923c", price:180, baseRent:14},
    {id:19, name:"–û—Ä–∞–Ω–∂–µ–≤—ã–π-3", type:"prop", color:"#fb923c", price:200, baseRent:16},
    {id:20, name:"–ë–ï–°–ü–õ–ê–¢–ù–ê–Ø –ü–ê–†–ö–û–í–ö–ê", type:"free"},
    {id:21, name:"–ö—Ä–∞—Å–Ω—ã–π-1", type:"prop", color:"#ef4444", price:220, baseRent:18},
    {id:22, name:"–®–∞–Ω—Å", type:"chance"},
    {id:23, name:"–ö—Ä–∞—Å–Ω—ã–π-2", type:"prop", color:"#ef4444", price:220, baseRent:18},
    {id:24, name:"–ö—Ä–∞—Å–Ω—ã–π-3", type:"prop", color:"#ef4444", price:240, baseRent:20},
    {id:25, name:"–ñ/–î —Å—Ç–∞–Ω—Ü–∏—è", type:"rail", price:200},
    {id:26, name:"–ñ—ë–ª—Ç—ã–π-1", type:"prop", color:"#facc15", price:260, baseRent:22},
    {id:27, name:"–ñ—ë–ª—Ç—ã–π-2", type:"prop", color:"#facc15", price:260, baseRent:22},
    {id:28, name:"–í–æ–¥–æ–∫–∞–Ω–∞–ª", type:"util", price:150},
    {id:29, name:"–ñ—ë–ª—Ç—ã–π-3", type:"prop", color:"#facc15", price:280, baseRent:24},
    {id:30, name:"–û—Ç–ø—Ä–∞–≤–ª—è–π—Ç–µ—Å—å –≤ –¢–Æ–†–¨–ú–£", type:"gojail"},
    {id:31, name:"–ó–µ–ª—ë–Ω—ã–π-1", type:"prop", color:"#22c55e", price:300, baseRent:26},
    {id:32, name:"–ó–µ–ª—ë–Ω—ã–π-2", type:"prop", color:"#22c55e", price:300, baseRent:26},
    {id:33, name:"–ö–∞—Å—Å–∞ —Å–æ–æ–±—â–µ—Å—Ç–≤–∞", type:"community"},
    {id:34, name:"–ó–µ–ª—ë–Ω—ã–π-3", type:"prop", color:"#22c55e", price:320, baseRent:28},
    {id:35, name:"–ñ/–î —Å—Ç–∞–Ω—Ü–∏—è", type:"rail", price:200},
    {id:36, name:"–®–∞–Ω—Å", type:"chance"},
    {id:37, name:"–°–∏–Ω–∏–π-1", type:"prop", color:"#3b82f6", price:350, baseRent:35},
    {id:38, name:"–ù–∞–ª–æ–≥ —Ä–æ—Å–∫–æ—à–∏", type:"tax", amount:100},
    {id:39, name:"–°–∏–Ω–∏–π-2", type:"prop", color:"#3b82f6", price:400, baseRent:50},
  ];

  const CHANCE = [
    {t:"–í–ø–µ—Ä—ë–¥ –Ω–∞ –°–¢–ê–†–¢, –ø–æ–ª—É—á–∏ 200", fn:(G)=>G.moveTo(0,true)},
    {t:"–ò–¥–∏ –≤ —Ç—é—Ä—å–º—É. –ù–µ –ø—Ä–æ—Ö–æ–¥–∏ –°–¢–ê–†–¢", fn:(G)=>G.toJail()},
    {t:"–®—Ç—Ä–∞—Ñ –∑–∞ –ø—Ä–µ–≤—ã—à–µ–Ω–∏–µ —Å–∫–æ—Ä–æ—Å—Ç–∏: –∑–∞–ø–ª–∞—Ç–∏ 15", fn:(G)=>G.pay(15)},
    {t:"–ü–æ–ª—É—á–∏—Ç–µ –¥–∏–≤–∏–¥–µ–Ω–¥—ã: +50", fn:(G)=>G.gain(50)},
  ];
  const COMMUNITY = [
    {t:"–í–µ—Ä–Ω–∏—Ç–µ –Ω–∞–ª–æ–≥–æ–≤—ã–π –≤—ã—á–µ—Ç: +100", fn:(G)=>G.gain(100)},
    {t:"–ú–µ–¥–æ—Å–º–æ—Ç—Ä: –∑–∞–ø–ª–∞—Ç–∏ 50", fn:(G)=>G.pay(50)},
    {t:"–ù–∞–π–¥–µ–Ω –∫–æ—à–µ–ª—ë–∫: +20", fn:(G)=>G.gain(20)},
    {t:"–û–ø–ª–∞—Ç–∞ —É—Å–ª—É–≥: –∑–∞–ø–ª–∞—Ç–∏ 25", fn:(G)=>G.pay(25)},
  ];

  // ======================
  // –£–¢–ò–õ–ò–¢–´
  // ======================
  const $ = (sel,root=document)=>root.querySelector(sel);
  const $$ = (sel,root=document)=>Array.from(root.querySelectorAll(sel));
  const log = (msg)=>{ const el=document.createElement('p'); el.textContent=msg; $('#log').prepend(el) };
  const toast = (msg)=>{ const t=$('#toast'); t.textContent=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),1200) };
  const anno = (lines=[], kind='info')=>{ const a=$('#anno'); a.innerHTML = lines.map(t=>`<div class="msg ${kind}">${t}</div>`).join(''); };
  const clearAnno = ()=>{ const a=$('#anno'); a.innerHTML=''; };

  function indexToGrid(n){
    const size=11; const last=size-1; // –∏–Ω–¥–µ–∫—Å—ã 0..10
    if(n<=10) return {row:last, col:last-n};
    if(n<=20) return {row:last-(n-10), col:0};
    if(n<=30) return {row:0, col:(n-20)};
    return {row:(n-30), col:last};
  }

  // –†–ï–ù–î–ï–† –î–û–°–ö–ò
  function renderBoard(){
    const board = $('#board');
    board.innerHTML = '';
    const center = document.createElement('div');
    center.className = 'center';
    center.innerHTML = '<div id="dice" class="dice-wrap"><div class="die" id="die1">1</div><div class="die" id="die2">1</div></div>';
    board.appendChild(center);

    for(let i=0;i<40;i++){
      const c = document.createElement('div');
      c.className = 'cell';
      const {row,col} = indexToGrid(i);
      c.style.gridRowStart = row+1; // grid 1-based
      c.style.gridColumnStart = col+1;
      c.textContent = BOARD[i]?.name || `–ö–ª–µ—Ç–∫–∞ ${i}`;
      c.dataset.index = i;
      const b = BOARD[i];
      if(b?.type==='prop'){
        const price = document.createElement('div');
        price.className = 'price';
        price.textContent = `$${b.price}`;
        c.appendChild(price);
      }
      board.appendChild(c);
    }
    updateOwnershipUI();
    renderPips();
  }

  function updateOwnershipUI(){
    $$('.cell').forEach(cell=>{
      cell.querySelectorAll('.owner-tag,.owner-chip').forEach(n=>n.remove());
    });
    Object.keys(Game.owned||{}).forEach(k=>{
      const idx = Number(k);
      const own = Game.owned[idx];
      if(own && typeof own.owner==='number'){
        const cell = document.querySelector(`.cell[data-index="${idx}"]`);
        if(!cell) return;
        const color = getPlayerColor(own.owner);
        const bar = document.createElement('div');
        bar.className='owner-tag';
        bar.style.background = color;
        const dot = document.createElement('div');
        dot.className='owner-chip';
        dot.style.background = color;
        cell.appendChild(bar);
        cell.appendChild(dot);
      }
    });
  }

  function getPlayerColor(pid){
    const p = Game.players && Game.players[pid];
    const map = { t0:'#60a5fa', t1:'#fca5a5', t2:'#86efac', t3:'#fcd34d' };
    return map[p?.color] || '#94a3b8';
  }

  // –ò–ì–†–û–í–ê–Ø –õ–û–ì–ò–ö–ê
  const Game = {
    players:[],
    current:0,
    dice:[1,1],
    owned:{},
    turnLock:false,
    phase:'awaitRoll',

    init(){
      this.players = [
        {id:0,name:'–ò–≥—Ä–æ–∫ 1',money:1500,pos:0,inJail:false,jailTurns:0,color:'t0'},
        {id:1,name:'–ò–≥—Ä–æ–∫ 2',money:1500,pos:0,inJail:false,jailTurns:0,color:'t1'},
      ];
      this.current = 0; this.owned = {}; this.turnLock=false; this.phase='awaitRoll';
      renderPlayers(); renderTokens();
      setActiveCell(0);
      log('–ù–æ–≤–∞—è –∏–≥—Ä–∞. –ò–≥—Ä–æ–∫ 1 –Ω–∞—á–∏–Ω–∞–µ—Ç.');
      updateTurnLabel();
      save();
    },

    roll(){
      clearAnno();
      if(this.turnLock || this.phase!=='awaitRoll') return; this.turnLock=true;
      const d1 = 1+Math.floor(Math.random()*6);
      const d2 = 1+Math.floor(Math.random()*6);
      this.dice=[d1,d2];
      showDice(d1,d2);
      log(`${this.cur().name} –±—Ä–æ—Å–∞–µ—Ç –∫–æ—Å—Ç–∏: ${d1} + ${d2}`);
      if(this.cur().inJail){
        if(d1===d2){ log('–î—É–±–ª—å! –í—ã—Ö–æ–¥ –∏–∑ —Ç—é—Ä—å–º—ã.'); this.cur().inJail=false; this.cur().jailTurns=0; this.phase='moving'; this.move(d1+d2); }
        else { this.cur().jailTurns++; log('–ù–µ –ø–æ–≤–µ–∑–ª–æ. –û—Å—Ç–∞–µ—Ç–µ—Å—å –≤ —Ç—é—Ä—å–º–µ.'); if(this.cur().jailTurns>=3){ log('–û–ø–ª–∞—á–∏–≤–∞–µ—Ç–µ 50 –∏ –≤—ã—Ö–æ–¥–∏—Ç–µ.'); this.pay(50,true); this.cur().inJail=false; this.cur().jailTurns=0; } this.turnLock=false; this.autoEnd(); update(); return; }
      } else {
        this.phase='moving';
        this.move(d1+d2);
      }
    },

    move(steps){
      const p = this.cur();
      let target = (p.pos + steps) % 40;
      if(p.pos + steps >= 40){ p.money += 200; toast('+$200 –∑–∞ –ø—Ä–æ—Ö–æ–¥ —á–µ—Ä–µ–∑ –°–¢–ê–†–¢'); log(`${p.name} –ø–æ–ª—É—á–∞–µ—Ç $200`); }
      animateMove(p.id, p.pos, target, ()=>{
        p.pos = target; this.land(); this.turnLock=false; update();
      });
    },

    land(){
      const p = this.cur();
      const tile = BOARD[p.pos];
      setActiveCell(p.pos);
      switch(tile.type){
        case 'go': log(`${p.name} –Ω–∞ –°–¢–ê–†–¢–µ`); this.autoEnd(); break;
        case 'tax': anno([`–ù–∞–ª–æ–≥: –æ–ø–ª–∞—Ç–∏—Ç—å $${tile.amount}.`],'rent'); this.pay(tile.amount); this.autoEnd(); break;
        case 'jail': log(`${p.name} –ø—Ä–æ—Å—Ç–æ –Ω–∞–≤–µ—â–∞–µ—Ç –∑–∞–∫–ª—é—á—ë–Ω–Ω—ã—Ö`); this.autoEnd(); break;
        case 'gojail': this.toJail(); this.autoEnd(); break;
        case 'chance': anno([`–ö–∞—Ä—Ç–∞ ¬´–®–∞–Ω—Å¬ª`],'info'); drawCard(CHANCE); this.autoEnd(); break;
        case 'community': anno([`–ö–∞—Å—Å–∞ —Å–æ–æ–±—â–µ—Å—Ç–≤–∞`],'info'); drawCard(COMMUNITY); this.autoEnd(); break;
        case 'prop':
        case 'rail':
        case 'util': this.handleProperty(p.pos); break;
        case 'free': log('–°–≤–æ–±–æ–¥–Ω–∞—è –ø–∞—Ä–∫–æ–≤–∫–∞. –ù–∏—á–µ–≥–æ –Ω–µ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç.'); this.autoEnd(); break;
        default: this.autoEnd();
      }
    },

    handleProperty(i){
      const tile = BOARD[i];
      const own = this.owned[i];
      const p = this.cur();
      $('#buy').disabled = true; $('#skipBuy').disabled = true; $('#buy').dataset.index='';
      if(!own){
        if(p.money >= (tile.price||0)){
          this.phase='awaitDecision';
          $('#buy').disabled = false; $('#skipBuy').disabled = false; $('#buy').dataset.index=i;
          anno([`${tile.name} –ø—Ä–æ–¥–∞—ë—Ç—Å—è –∑–∞ $${tile.price}.`,`–ù–∞–∂–º–∏—Ç–µ ¬´–ö—É–ø–∏—Ç—å¬ª –∏–ª–∏ ¬´–ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å¬ª.`],'buy');
          log(`${tile.name} –ø—Ä–æ–¥–∞—ë—Ç—Å—è –∑–∞ $${tile.price}. –ù–∞–∂–º–∏—Ç–µ \"–ö—É–ø–∏—Ç—å\" –∏–ª–∏ \"–ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å\".`);
        } else {
          anno([`${tile.name}: –Ω–µ —Ö–≤–∞—Ç–∞–µ—Ç –¥–µ–Ω–µ–≥ –¥–ª—è –ø–æ–∫—É–ø–∫–∏.`],'info');
          log(`${tile.name} –Ω–µ–ª—å–∑—è –∫—É–ø–∏—Ç—å: –Ω–µ —Ö–≤–∞—Ç–∞–µ—Ç –¥–µ–Ω–µ–≥.`); this.autoEnd();
        }
      } else if(own.owner !== p.id){
        const rent = calcRent(i);
        anno([`–ö–ª–µ—Ç–∫–∞ –∑–∞–Ω—è—Ç–∞: –≤–ª–∞–¥–µ–ª–µ—Ü ‚Äî ${this.players[own.owner].name}.`,`–û–ø–ª–∞—Ç–∏—Ç–µ —Ä–µ–Ω—Ç—É $${rent}.`],'rent');
        log(`${p.name} –ø–ª–∞—Ç–∏—Ç —Ä–µ–Ω—Ç—É $${rent} –∏–≥—Ä–æ–∫—É ${this.players[own.owner].name}`);
        this.transfer(p.id, own.owner, rent);
        this.autoEnd();
      } else {
        anno([`${tile.name} –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–∏—Ç –≤–∞–º.`],'info');
        log(`${tile.name} –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–∏—Ç –≤–∞–º.`); this.autoEnd();
      }
    },

    buy(index){
      if(this.phase!=='awaitDecision') return;
      const tile = BOARD[index];
      const p = this.cur();
      if(this.owned[index]){ toast('–£–∂–µ –∫—É–ø–ª–µ–Ω–æ'); this.autoEnd(); return; }
      if((tile.price||0) > p.money){ toast('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–µ–Ω–µ–≥'); this.autoEnd(); return; }
      p.money -= tile.price||0; this.owned[index] = {owner:p.id, houses:0, hotel:false};
      log(`${p.name} –ø–æ–∫—É–ø–∞–µ—Ç ${tile.name} –∑–∞ $${tile.price}`);
      update(); save();
      this.phase='awaitRoll';
      this.endTurn();
    },

    skip(){ if(this.phase==='awaitDecision'){ log('–ü–æ–∫—É–ø–∫–∞ –ø—Ä–æ–ø—É—â–µ–Ω–∞.'); this.phase='awaitRoll'; this.endTurn(); } },

    pay(amount, silent){
      const p = this.cur(); p.money -= amount; if(!silent) log(`${p.name} –ø–ª–∞—Ç–∏—Ç $${amount}`); update(); save();
      if(p.money < 0){ toast('–ë–∞–Ω–∫—Ä–æ—Ç—Å—Ç–≤–æ –±–ª–∏–∑–∫–æ'); }
    },
    gain(amount){ const p=this.cur(); p.money += amount; log(`${p.name} –ø–æ–ª—É—á–∞–µ—Ç $${amount}`); update(); save(); },
    transfer(from,to,amt){ this.players[from].money -= amt; this.players[to].money += amt; update(); save(); },

    toJail(){ const p=this.cur(); p.pos=10; p.inJail=true; p.jailTurns=0; setActiveCell(10); log(`${p.name} –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –≤ —Ç—é—Ä—å–º—É.`); renderTokens(); save(); },
    moveTo(i, passGo){
      const p=this.cur();
      if(passGo && i < p.pos){ p.money += 200; log(`${p.name} –ø–æ–ª—É—á–∞–µ—Ç $200 –∑–∞ –ø—Ä–æ—Ö–æ–¥ —á–µ—Ä–µ–∑ –°–¢–ê–†–¢`); }
      animateMove(p.id, p.pos, i, ()=>{ p.pos=i; this.land(); update(); save(); });
    },

    autoEnd(){
      if(this.phase==='awaitDecision'){ return; }
      this.phase='awaitRoll';
      setTimeout(()=>this.endTurn(), 400);
    },

    endTurn(){ this.current = (this.current+1)%this.players.length; updateTurnLabel(); save(); },
    cur(){ return this.players[this.current]; }
  };

  function calcRent(i){
    const t = BOARD[i]; const own = Game.owned[i];
    if(t.type==='prop'){
      const same = BOARD.filter(x=>x.type==='prop' && x.color===t.color);
      const ownedAll = same.every(x=> Game.owned[x.id]?.owner === own.owner);
      let rent = t.baseRent || 0;
      if(ownedAll) rent*=2;
      rent += (own.houses||0) * t.baseRent;
      if(own.hotel) rent *= 3;
      return rent;
    }
    if(t.type==='rail'){
      const count = BOARD
        .map((x,idx)=>({x,idx}))
        .filter(o=>o.x.type==='rail' && Game.owned[o.idx]?.owner===own.owner).length;
      return [25,50,100,200][count-1] || 25;
    }
    if(t.type==='util'){
      const mult = Object.values(Game.owned).filter(o=>{
        const idx = Number(Object.keys(Game.owned).find(k=>Game.owned[k]===o));
        return BOARD[idx]?.type==='util' && o.owner===own.owner;
      }).length>=2 ? 10 : 4;
      const sum = Game.dice[0]+Game.dice[1];
      return mult*sum;
    }
    return 0;
  }

  function drawCard(deck){
    const card = deck[Math.floor(Math.random()*deck.length)];
    toast(card.t); anno([card.t],'info'); log(`–ö–∞—Ä—Ç–∞: ${card.t}`); card.fn(Game); update(); save();
  }

  // ======= –ü–ò–ü–ö–ò-–ü–û–ó–ò–¶–ò–ò –ò–ì–†–û–ö–û–í =======
  function renderPips(){
    $$('.cell').forEach(cell=> cell.querySelectorAll('.pips').forEach(n=>n.remove()));
    const byCell = new Map();
    Game.players.forEach((p)=>{
      const arr = byCell.get(p.pos) || []; arr.push(p); byCell.set(p.pos, arr);
    });
    byCell.forEach((arr, idx)=>{
      const cell = $(`.cell[data-index="${idx}"]`); if(!cell) return;
      const wrap = document.createElement('div'); wrap.className='pips';
      arr.forEach(p=>{
        const dot = document.createElement('div'); dot.className='pip'; dot.style.background = getPlayerColor(p.id);
        wrap.appendChild(dot);
      });
      cell.appendChild(wrap);
    });
  }
  // –°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å: —Å—Ç–∞—Ä—ã–π –≤—ã–∑–æ–≤ –±–æ–ª—å—à–∏—Ö —Ñ–∏—à–µ–∫ –ø–æ–¥–º–µ–Ω—è–µ–º –Ω–∞ –ø–∏–ø–∫–∏
  function renderTokens(){ renderPips(); }
  function positionTokens(){ /* –±–æ–ª—å—à–∏–µ —Ñ–∏—à–∫–∏ –æ—Ç–∫–ª—é—á–µ–Ω—ã */ }

  function animateMove(pid, from, to, done){
    const steps = ((to - from) + 40) % 40;
    let i = 0;
    const step = ()=>{
      const p = Game.players[pid];
      p.pos = (from + i) % 40;
      renderPips(); setActiveCell(p.pos);
      if(i++ < steps) requestAnimationFrame(()=>setTimeout(step, 80));
      else { p.pos = to; renderPips(); done && done(); }
    };
    step();
  }

  function renderPlayers(){
    const wrap = $('#players'); wrap.innerHTML='';
    Game.players.forEach((p,idx)=>{
      const el = document.createElement('div'); el.className='player'+(idx===Game.current?' you':'');
      el.innerHTML = `<div><strong>${p.name}</strong></div><div class="money">$${p.money}</div>`;
      wrap.appendChild(el);
    });
  }

  function updateTurnLabel(){ $('#turnLabel').textContent = `–•–æ–¥: ${Game.cur().name}`; renderPlayers(); }
  function setActiveCell(i){
    $$('.cell').forEach(c=>{ c.classList.remove('active'); c.style.boxShadow=''; });
    const c=$(`.cell[data-index="${i}"]`);
    if(c){
      const color = getPlayerColor(Game.current);
      c.classList.add('active');
      c.style.boxShadow = `0 0 0 3px ${color} inset`;
    }
  }
  function update(){ renderPlayers(); renderPips(); updateOwnershipUI(); }

  // ======= –•–†–ê–ù–ï–ù–ò–ï =======
  function save(){ localStorage.setItem('mono.save', JSON.stringify({players:Game.players,current:Game.current,owned:Game.owned,dice:Game.dice})); }
  function load(){ const raw=localStorage.getItem('mono.save'); if(!raw) return false; try{ const s=JSON.parse(raw); Object.assign(Game, s); return true; }catch(e){ return false; } }

  // ======= –ö–ù–û–ü–ö–ò =======
  $('#newGame').addEventListener('click', ()=>{ Game.init(); });
  $('#roll').addEventListener('click', ()=>Game.roll());
  $('#buy').addEventListener('click', (e)=>{ const idx = Number(e.currentTarget.dataset.index); if(Number.isFinite(idx)) Game.buy(idx); e.currentTarget.disabled=true; $('#skipBuy').disabled=true; });
  $('#skipBuy').addEventListener('click', ()=>{ Game.skip(); $('#buy').disabled=true; $('#skipBuy').disabled=true; });
  $('#sell').addEventListener('click', ()=>toast('–ü—Ä–æ–¥–∞–∂–∞/–∏–ø–æ—Ç–µ–∫–∞: –≤ –ø—Ä–æ—Ç–æ—Ç–∏–ø–µ –Ω–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ'));
  $('#build').addEventListener('click', ()=>toast('–°—Ç—Ä–æ–π–∫–∞: –≤ –ø—Ä–æ—Ç–æ—Ç–∏–ø–µ —É–ø—Ä–æ—â–µ–Ω–∞; –¥–æ–±–∞–≤–∏—Ç—å –º–µ–Ω—é –ø–æ–∑–∂–µ'));
  $('#help').addEventListener('click', ()=>alert('–•–æ–¥ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç —Å–ª–µ–¥—É—é—â–µ–º—É –∏–≥—Ä–æ–∫—É. –ü—Ä–∏ –ø–æ–∫—É–ø–∫–µ –ø–æ—è–≤—è—Ç—Å—è –∫–Ω–æ–ø–∫–∏ ¬´–ö—É–ø–∏—Ç—å/–ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å¬ª.'));
  $('#save').addEventListener('click', ()=>{ save(); toast('–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ'); });

  // ======= –°–¢–ê–†–¢ =======
  renderBoard();
  clearAnno();
  if(!load()) Game.init(); else { renderPlayers(); renderTokens(); updateTurnLabel(); setActiveCell(Game.cur().pos); }
  window.addEventListener('resize', positionTokens);

  // ======= UI –∫–æ—Å—Ç–µ–π =======
  function showDice(d1,d2){
    const a=$('#die1'), b=$('#die2');
    [a,b].forEach(el=>{ el.classList.add('shake'); setTimeout(()=>el.classList.remove('shake'),350); });
    a.textContent=d1; b.textContent=d2;
  }

  // ======= –°–ê–ú–û–¢–ï–°–¢–´ =======
  (function runSelfTests(){
    try{
      console.assert(typeof renderTokens==='function','renderTokens –¥–æ–ª–∂–µ–Ω —Å—É—â–µ—Å—Ç–≤–æ–≤–∞—Ç—å');
      console.assert(BOARD.length===40,'–î–æ–ª–∂–Ω–æ –±—ã—Ç—å 40 –∫–ª–µ—Ç–æ–∫');
      console.assert(document.getElementById('die1'), '–î–æ–ª–∂–µ–Ω —Å—É—â–µ—Å—Ç–≤–æ–≤–∞—Ç—å die1');
      console.assert(!document.querySelector('.logo'), '–õ–æ–≥–æ –≤ —Ü–µ–Ω—Ç—Ä–µ –±—ã—Ç—å –Ω–µ –¥–æ–ª–∂–Ω–æ');

      // –ê–Ω–Ω–æ—Ç–∞—Ü–∏—è –ø–æ—è–≤–ª—è–µ—Ç—Å—è –∏ –æ—á–∏—â–∞–µ—Ç—Å—è
      anno(['–¢–µ—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ'],'info');
      console.assert(document.querySelector('#anno .msg'),'–ê–Ω–Ω–æ—Ç–∞—Ü–∏—è –¥–æ–ª–∂–Ω–∞ –ø–æ—è–≤–ª—è—Ç—å—Å—è');
      clearAnno();
      console.assert(!document.querySelector('#anno .msg'),'–ê–Ω–Ω–æ—Ç–∞—Ü–∏—è –¥–æ–ª–∂–Ω–∞ –æ—á–∏—â–∞—Ç—å—Å—è');

      // –î–æ –ø–æ–∫—É–ø–∫–∏ –º–µ—Ç–æ–∫ –Ω–µ—Ç, –ø–æ—Å–ª–µ –ø–æ–∫—É–ø–∫–∏ –ø–æ—è–≤–ª—è—é—Ç—Å—è
      const idxToTest = 1; // –ë—Ä–∞—É–Ω-1
      const cell = document.querySelector(`.cell[data-index="${idxToTest}"]`);
      console.assert(cell && !cell.querySelector('.owner-tag'), '–î–æ –ø–æ–∫—É–ø–∫–∏ –Ω–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –º–µ—Ç–æ–∫ –≤–ª–∞–¥–µ–ª—å—Ü–∞');
      Game.owned[idxToTest] = {owner:0, houses:0, hotel:false};
      updateOwnershipUI();
      console.assert(cell.querySelector('.owner-tag') && cell.querySelector('.owner-chip'), '–ü–æ—Å–ª–µ –ø–æ–∫—É–ø–∫–∏ –º–µ—Ç–∫–∏ –≤–ª–∞–¥–µ–ª—å—Ü–∞ –¥–æ–ª–∂–Ω—ã –ø–æ—è–≤–∏—Ç—å—Å—è');

      // –¢–µ—Å—Ç —Å–µ–π–≤–∞
      save();
      const raw = localStorage.getItem('mono.save');
      console.assert(!!raw,'–°–µ–π–≤ –¥–æ–ª–∂–µ–Ω –∑–∞–ø–∏—Å—ã–≤–∞—Ç—å—Å—è');
      console.debug('[DEV] –°–∞–º–æ—Ç–µ—Å—Ç—ã –ø—Ä–æ—à–ª–∏');
    }catch(e){
      console.warn('–°–∞–º–æ—Ç–µ—Å—Ç—ã: –ø—Ä–æ–±–ª–µ–º–∞', e);
    }
  })();
  </script>
</body>
</html>
