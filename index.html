<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>–ú–æ–Ω–æ–ø–æ–ª–∏—è ‚Äî —É–ª—É—á—à–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è</title>
  <style>
    :root{ --bg:#0f172a; --panel:#111827; --muted:#334155; --text:#e5e7eb; --accent:#f59e0b; --ok:#22c55e; --bad:#ef4444; }
    html,body{height:100dvh;margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,sans-serif;overflow:hidden}
    .app{display:grid;grid-template-columns:minmax(0,1fr) 380px;gap:16px;height:100dvh;padding:16px;box-sizing:border-box}
    .board-wrap{display:grid;place-items:center;background:linear-gradient(180deg,#0b1225,#0a0f1f);border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.35);position:relative;height:100%;width:100%;max-height:100dvh;min-height:0;aspect-ratio:auto}

    .board{width:100%;height:100%;display:grid;grid-template-columns:repeat(11,1fr);grid-template-rows:repeat(11,1fr);gap:4px;padding:8px;box-sizing:border-box}
    .cell{background:#111827;border:1px solid #1f2937;border-radius:8px;display:flex;align-items:center;justify-content:center;text-align:center;padding:6px;font-size:clamp(10px,1.4vmin,16px);position:relative;transition:all 0.15s ease}
    .cell .price{position:absolute;bottom:4px;right:6px;font-size:.8em;color:#94a3b8}
    .center{grid-area:3/3/span 7/span 7;border-radius:16px;background:radial-gradient(ellipse at center,#0c1328 0%,#0a0f1f 60%,#0a0f1f 100%);display:grid;place-items:center;position:relative}

    .dice-wrap{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;gap:14px;pointer-events:none}
    .die{width:min(9vmin,72px);height:min(9vmin,72px);border-radius:18px;background:linear-gradient(145deg,#f8f9fa,#e9ecef);border:2px solid #dee2e6;display:flex;align-items:center;justify-content:center;font-weight:900;font-size:calc(min(9vmin,72px)*0.5);color:#212529;box-shadow:0 6px 16px rgba(0,0,0,.4);opacity:.95}
    .die.shake{animation:shake .5s ease both}
    @keyframes shake{0%{transform:rotate(0) scale(1)}25%{transform:rotate(10deg) scale(1.08)}50%{transform:rotate(-10deg) scale(1.08)}75%{transform:rotate(8deg) scale(1.05)}100%{transform:rotate(0) scale(1)}}

    .side{background:var(--panel);border:1px solid #1f2937;border-radius:16px;display:grid;grid-template-rows:auto auto 1fr auto;overflow:auto;min-height:0}
    .bar{display:flex;gap:8px;padding:12px;border-bottom:1px solid #1f2937;align-items:center}
    button{background:#1f2937;color:var(--text);border:1px solid #334155;border-radius:10px;padding:10px 12px;font-weight:600;cursor:pointer;transition:all 0.2s}
    button:hover:not(:disabled){border-color:#475569;background:#2d3748;transform:translateY(-1px)}
    button:disabled{opacity:0.4;cursor:not-allowed}
    .big{font-size:18px;padding:14px 16px}
    .row{display:flex;gap:8px;flex-wrap:wrap}
    .log{padding:12px;overflow:auto;font-size:14px}
    .log p{margin:.3em 0;padding:6px 8px;background:#0a0f1f;border-radius:6px;border-left:3px solid #334155}
    .log p.important{border-left-color:#f59e0b;background:#1a1508}
    .players{padding:12px;border-top:1px solid #1f2937;display:grid;gap:10px}
    .player{display:flex;justify-content:space-between;align-items:center;background:#0b1222;border:1px solid #1f2937;border-radius:12px;padding:10px;transition:all 0.2s}
    .player.you{border-color:#f59e0b;box-shadow:0 0 12px rgba(245,158,11,0.2)}
    .player.in-jail{border-color:#ef4444;background:#1a0a0c}
    .money{font-weight:700;color:#22c55e;font-size:16px}
    .player .id{display:flex;align-items:center;gap:8px}
    .swatch{width:12px;height:12px;border-radius:3px;border:1px solid rgba(255,255,255,.6);box-shadow:0 1px 2px rgba(0,0,0,.3)}

    .tokens{display:none}
    .token{display:none}

    /* –£–õ–£–ß–®–ï–ù–ù–´–ï –§–ò–®–ö–ò - –í–ò–î–ò–ú–´–ï –ò –ê–ù–ò–ú–ò–†–û–í–ê–ù–ù–´–ï */
    .pips{position:absolute;bottom:6px;left:6px;display:flex;gap:4px;z-index:10}
    .pip{
      width:14px;
      height:14px;
      border-radius:50%;
      border:2px solid rgba(255,255,255,.9);
      box-shadow:0 3px 8px rgba(0,0,0,.6), 0 0 0 1px rgba(0,0,0,.3);
      transition:transform 0.15s ease;
    }
    .pip:hover{transform:scale(1.2)}
    
    /* –ê–ù–ò–ú–ê–¶–ò–Ø –î–í–ò–ñ–ï–ù–ò–Ø –§–ò–®–ö–ò */
    @keyframes moveToken {
      0% { transform: scale(1); }
      50% { transform: scale(1.3); }
      100% { transform: scale(1); }
    }
    .pip.moving {
      animation: moveToken 0.3s ease;
      z-index:20;
    }

    .toast{position:absolute;left:50%;bottom:18px;transform:translateX(-50%);background:#111827;border:2px solid #f59e0b;border-radius:12px;padding:12px 18px;font-weight:700;font-size:15px;opacity:0;transition:opacity .25s;box-shadow:0 6px 16px rgba(0,0,0,.4);z-index:100}
    .toast.show{opacity:1}

    .ui{display:grid;grid-template-columns:1fr 1fr;gap:8px;padding:12px;border-top:1px solid #1f2937}
    .ui button{font-size:16px;padding:14px}

    /* –ê–ö–¢–ò–í–ù–ê–Ø –ö–õ–ï–¢–ö–ê - –ü–û–î–°–í–ï–¢–ö–ê */
    .cell.active{
      box-shadow:0 0 0 3px var(--accent) inset;
      transform:scale(1.03);
      z-index:5;
    }
    
    /* –í–†–ï–ú–ï–ù–ù–ê–Ø –ü–û–î–°–í–ï–¢–ö–ê –ü–†–ò –î–í–ò–ñ–ï–ù–ò–ò */
    .cell.moving-through{
      background:#1e293b;
      box-shadow:0 0 8px rgba(245,158,11,0.4);
    }

    .owner-tag{position:absolute;left:0;bottom:0;height:6px;width:100%;border-bottom-left-radius:8px;border-bottom-right-radius:8px;opacity:.95}

    .anno{position:absolute;left:50%;top:30%;transform:translate(-50%,-50%);max-width:60%;padding:16px 20px;border-radius:14px;background:rgba(17,24,39,.85);border:2px solid #475569;backdrop-filter:blur(5px);font-size:clamp(14px,2.2vmin,20px);line-height:1.4;white-space:pre-line;pointer-events:none;z-index:15;text-align:left;box-shadow:0 8px 24px rgba(0,0,0,.5)}
    .anno .msg{margin:.25em 0;font-weight:800}
    .anno .buy{color:#22c55e}.anno .rent{color:#ef4444}.anno .info{color:#e5e7eb}

    .overlay{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;z-index:30;backdrop-filter:blur(2px)}
    .overlay.show{display:flex}
    .card{background:#0b1222;border:2px solid #334155;border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.5);padding:20px;min-width:min(92vw,560px)}
    .card h2{color:#f59e0b;margin-bottom:16px}
    .grid{display:grid;gap:10px}
    .grid.cols-2{grid-template-columns:1fr 1fr}
    .field{display:grid;gap:6px}
    .field label{font-weight:600;color:#94a3b8}
    .field input{background:#0f172a;border:2px solid #334155;color:var(--text);padding:10px;border-radius:8px;font-size:15px}
    .field input:focus{outline:none;border-color:#f59e0b}
    .list{display:grid;gap:8px;max-height:55vh;overflow:auto}
    .item{display:flex;justify-content:space-between;align-items:center;border:1px solid #334155;background:#0b1528;border-radius:10px;padding:10px}
    .item button{padding:6px 10px}

    .turn-hud{position:absolute;left:50%;top:58%;transform:translate(-50%,-50%);padding:8px 14px;border:2px solid #f59e0b;background:rgba(17,24,39,.9);border-radius:10px;font-weight:700;font-size:16px;opacity:.95;display:flex;align-items:center;gap:8px;box-shadow:0 4px 12px rgba(0,0,0,.4)}
    .turn-hud .swatch{width:14px;height:14px;border-radius:3px;border:2px solid rgba(255,255,255,.7)}
    .quickbar{position:absolute;left:50%;top:68%;transform:translate(-50%,-50%);display:flex;gap:10px;background:#0b1324;border:1px solid #334155;border-radius:12px;padding:8px 10px;z-index:6}
    .quickbar[hidden]{display:none}
    
    /* –°–ß–Å–¢–ß–ò–ö –ü–†–û–ü–£–°–ö–û–í –í –¢–Æ–†–¨–ú–ï */
    .jail-badge{
      background:#ef4444;
      color:white;
      padding:3px 8px;
      border-radius:6px;
      font-size:11px;
      font-weight:800;
      margin-left:8px;
    }
  </style>
</head>
<body>
  <div class="app">
    <div class="board-wrap">
      <div class="board" id="board"></div>
      <div id="turnHud" class="turn-hud"><span class="swatch"></span><span id="turnHudName">‚Äî</span></div>
      <div id="quickBar" class="quickbar" hidden>
        <button id="qbMortgage">–í –∑–∞–ª–æ–≥</button>
        <button id="qbSell">–ü—Ä–æ–¥–∞—Ç—å</button>
        <button id="qbManage">–û—Ç–∫—Ä—ã—Ç—å —Ñ–∏–Ω–∞–Ω—Å—ã</button>
      </div>
      <div class="tokens" id="tokens"></div>
      <div id="anno" class="anno" aria-live="polite"></div>
      <div class="toast" id="toast">&nbsp;</div>
    </div>

    <aside class="side">
      <div class="bar">
        <button id="newGame" class="big">üéÆ –ù–æ–≤–∞—è –∏–≥—Ä–∞</button>
        <div style="flex:1"></div>
        <strong id="turnLabel">–•–æ–¥: ‚Äî</strong>
      </div>

      <div class="row" style="padding:10px">
        <button id="roll" class="big" style="background:#16a34a;border-color:#16a34a">üé≤ –ë—Ä–æ—Å–∏—Ç—å –∫–æ—Å—Ç–∏</button>
        <button id="payBail" title="–ó–∞–ø–ª–∞—Ç–∏—Ç—å $50 –∏ –≤—ã–π—Ç–∏" style="background:#dc2626;border-color:#dc2626">üí∞ –ó–∞–ø–ª–∞—Ç–∏—Ç—å $50</button>
        <button id="stayJail" disabled>‚è≠Ô∏è –ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å —Ö–æ–¥</button>
        <button id="buy" disabled style="background:#0284c7;border-color:#0284c7">‚úÖ –ö—É–ø–∏—Ç—å</button>
        <button id="skipBuy" disabled>‚ùå –ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å</button>
        <button id="manage" class="big">üíº –§–∏–Ω–∞–Ω—Å—ã</button>
      </div>

      <div class="log" id="log"></div>
      <div class="players" id="players"></div>

      <div class="ui">
        <button id="help">üìñ –ü—Ä–∞–≤–∏–ª–∞</button>
        <button id="save">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      </div>
    </aside>
  </div>

  <!-- –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –Ω–æ–≤–æ–π –∏–≥—Ä—ã -->
  <div class="overlay" id="setup">
    <div class="card">
      <h2 style="margin:0 0 12px 0">üéÆ –ù–æ–≤–∞—è –∏–≥—Ä–∞ –ú–æ–Ω–æ–ø–æ–ª–∏—è</h2>
      <div class="grid cols-2">
        <div class="field"><label>–ö–æ–ª-–≤–æ –∏–≥—Ä–æ–∫–æ–≤ (2‚Äì4)</label><input id="pCount" type="number" min="2" max="4" value="2"/></div>
        <div class="field"><label>–ù–∞—á–∞–ª—å–Ω—ã–µ –¥–µ–Ω—å–≥–∏ ($)</label><input id="startMoney" type="number" min="500" step="50" value="1500"/></div>
      </div>
      <div class="grid" id="names"></div>
      <div class="row" style="margin-top:12px">
        <button id="startGame" class="big" style="background:#16a34a;border-color:#16a34a">‚ñ∂Ô∏è –ù–∞—á–∞—Ç—å</button>
        <div style="flex:1"></div>
        <button id="cancelSetup">–û—Ç–º–µ–Ω–∞</button>
      </div>
    </div>
  </div>

  <!-- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å—é -->
  <div class="overlay" id="manageDlg">
    <div class="card">
      <h2 style="margin:0 0 12px 0">üíº –°–æ–±—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å</h2>
      <div class="list" id="assetList"></div>
      <div class="row" style="margin-top:12px"><div style="flex:1"></div><button id="closeManage">–ó–∞–∫—Ä—ã—Ç—å</button></div>
    </div>
  </div>

  <script>
  // ---------- –î–ê–ù–ù–´–ï ----------
  const BOARD = [
    {id:0,name:'START',type:'go'},
    {id:1,name:'NARVAVAGEN',type:'prop',color:'brown',price:60,baseRent:2},
    {id:2,name:'BYGGMADER',type:'chance'},
    {id:3,name:'KARLAVAEGEN',type:'prop',color:'brown',price:60,baseRent:4},
    {id:4,name:'SKATT',type:'tax',amount:200},
    {id:5,name:'OESTERBYGATAN',type:'station',price:200,baseRent:25},
    {id:6,name:'ALLMANNINGEN',type:'prop',color:'lightblue',price:100,baseRent:6},
    {id:7,name:'CHANS',type:'chance'},
    {id:8,name:'STUREGATAN',type:'prop',color:'lightblue',price:100,baseRent:6},
    {id:9,name:'GOETAGATAN',type:'prop',color:'lightblue',price:120,baseRent:8},
    {id:10,name:'F√ÑNGELSE',type:'jail'},
    {id:11,name:'LAXGATAN',type:'prop',color:'pink',price:140,baseRent:10},
    {id:12,name:'ELEKTR.VERK',type:'utility',price:150,baseRent:0},
    {id:13,name:'RINGAVAEGEN',type:'prop',color:'pink',price:140,baseRent:10},
    {id:14,name:'GAMLA STAN',type:'prop',color:'pink',price:160,baseRent:12},
    {id:15,name:'NARKS. GATAN',type:'station',price:200,baseRent:25},
    {id:16,name:'SVEAVAGEN',type:'prop',color:'orange',price:180,baseRent:14},
    {id:17,name:'BYGGMADER',type:'chance'},
    {id:18,name:'KUNGSGATAN',type:'prop',color:'orange',price:180,baseRent:14},
    {id:19,name:'MOENSTERSAMT',type:'prop',color:'orange',price:200,baseRent:16},
    {id:20,name:'PARKERING',type:'parking'},
    {id:21,name:'STRANDVAEGEN',type:'prop',color:'red',price:220,baseRent:18},
    {id:22,name:'CHANS',type:'chance'},
    {id:23,name:'NORRMARLM ST',type:'prop',color:'red',price:220,baseRent:18},
    {id:24,name:'HAMNGATAN',type:'prop',color:'red',price:240,baseRent:20},
    {id:25,name:'NOERRKOEP.',type:'station',price:200,baseRent:25},
    {id:26,name:'VASAGATAN',type:'prop',color:'yellow',price:260,baseRent:22},
    {id:27,name:'STRANDVAGEN',type:'prop',color:'yellow',price:260,baseRent:22},
    {id:28,name:'VATTENVERK',type:'utility',price:150,baseRent:0},
    {id:29,name:'BIBLIOTEKSG.',type:'prop',color:'yellow',price:280,baseRent:24},
    {id:30,name:'G√Ö TILL F√ÑNGELSE',type:'gotojail'},
    {id:31,name:'OESTERM.TORG',type:'prop',color:'green',price:300,baseRent:26},
    {id:32,name:'NARVAV√ÑGEN',type:'prop',color:'green',price:300,baseRent:26},
    {id:33,name:'BYGGMADER',type:'chance'},
    {id:34,name:'STOERGATAN',type:'prop',color:'green',price:320,baseRent:28},
    {id:35,name:'VAESTRA ST.',type:'station',price:200,baseRent:25},
    {id:36,name:'CHANS',type:'chance'},
    {id:37,name:'DJURGAARDEN',type:'prop',color:'darkblue',price:350,baseRent:35},
    {id:38,name:'SKATT',type:'tax',amount:100},
    {id:39,name:'STUREPLAN',type:'prop',color:'darkblue',price:400,baseRent:50}
  ];

  const Game = {
    players: [],
    current: 0,
    owned: {},
    dice: [1, 1],
    
    cur() { return this.players[this.current]; },
    
    initFromConfig({names, money}) {
      this.players = names.map((n, i) => ({
        id: i,
        name: n,
        money,
        pos: 0,
        jailTurns: 0
      }));
      this.current = 0;
      this.owned = {};
      this.dice = [1, 1];
      update();
      updateTurnLabel();
      renderBoard();
      toast('üéÆ –ò–≥—Ä–∞ –Ω–∞—á–∞—Ç–∞!');
      log('–ò–≥—Ä–∞ –Ω–∞—á–∞—Ç–∞ —Å ' + this.players.length + ' –∏–≥—Ä–æ–∫–∞–º–∏', true);
    },
    
    // ========== –£–õ–£–ß–®–ï–ù–ù–ê–Ø –ú–ï–•–ê–ù–ò–ö–ê –ë–†–û–°–ö–ê –ö–û–°–¢–ï–ô ==========
    roll() {
      const p = this.cur();
      
      // –í —Ç—é—Ä—å–º–µ?
      if (p.jailTurns > 0) {
        toast('‚ùå –í—ã –≤ —Ç—é—Ä—å–º–µ! –í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ.');
        log(`‚ùå ${p.name} –Ω–µ –º–æ–∂–µ—Ç —Ö–æ–¥–∏—Ç—å - –≤ —Ç—é—Ä—å–º–µ!`, true);
        $('#payBail').disabled = false;
        $('#stayJail').disabled = false;
        $('#roll').disabled = true;
        return;
      }
      
      // –ë—Ä–æ—Å–∞–µ–º –∫–æ—Å—Ç–∏
      const d1 = Math.floor(Math.random() * 6) + 1;
      const d2 = Math.floor(Math.random() * 6) + 1;
      this.dice = [d1, d2];
      showDice(d1, d2);
      
      const sum = d1 + d2;
      const isDouble = d1 === d2;
      
      log(`üé≤ ${p.name} –≤—ã–±—Ä–æ—Å–∏–ª ${d1} + ${d2} = ${sum}${isDouble ? ' (–î–£–ë–õ–¨!)' : ''}`);
      
      // –û—Ç–∫–ª—é—á–∞–µ–º –∫–Ω–æ–ø–∫–∏ –≤–æ –≤—Ä–µ–º—è –¥–≤–∏–∂–µ–Ω–∏—è
      $('#roll').disabled = true;
      
      const oldPos = p.pos;
      const newPos = (oldPos + sum) % 40;
      
      // –ü—Ä–æ—à–ª–∏ START?
      const passedStart = newPos < oldPos;
      
      // –ê–ù–ò–ú–ê–¶–ò–Ø –î–í–ò–ñ–ï–ù–ò–Ø –ü–û –ö–õ–ï–¢–û–ß–ö–ê–ú
      animateMove(p.id, oldPos, newPos, () => {
        p.pos = newPos;
        
        if (passedStart) {
          p.money += 200;
          log(`üí∞ ${p.name} –ø—Ä–æ—à—ë–ª START –∏ –ø–æ–ª—É—á–∏–ª $200!`, true);
          toast('üí∞ +$200 –∑–∞ –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏–µ START!');
        }
        
        this.landOn(newPos);
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º: –Ω—É–∂–Ω–æ –ª–∏ –∏–≥—Ä–æ–∫—É –ø—Ä–∏–Ω—è—Ç—å —Ä–µ—à–µ–Ω–∏–µ –æ –ø–æ–∫—É–ø–∫–µ?
        const cell = BOARD[newPos];
        const needsDecision = (cell.type === 'prop' || cell.type === 'station' || cell.type === 'utility') && !this.owned[newPos];
        
        if (needsDecision) {
          // –ò–≥—Ä–æ–∫ –¥–æ–ª–∂–µ–Ω –≤—ã–±—Ä–∞—Ç—å: –∫—É–ø–∏—Ç—å –∏–ª–∏ –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å
          // –•–æ–¥ –ù–ï –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
          if (isDouble) {
            toast('üé≤ –î—É–±–ª—å! –ù–æ —Å–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ: –∫—É–ø–∏—Ç—å –∏–ª–∏ –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å');
            log(`üîÑ ${p.name} –≤—ã–±—Ä–æ—Å–∏–ª –¥—É–±–ª—å, –Ω–æ –¥–æ–ª–∂–µ–Ω —Ä–µ—à–∏—Ç—å –æ –ø–æ–∫—É–ø–∫–µ`);
          }
        } else {
          // –ù–µ—Ç –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –≤ —Ä–µ—à–µ–Ω–∏–∏ - –ø–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —Ö–æ–¥—É –∏–ª–∏ –¥–∞—ë–º –¥—É–±–ª—å
          if (isDouble) {
            toast('üé≤ –î—É–±–ª—å! –ë—Ä–æ—Å–∞–π—Ç–µ —Å–Ω–æ–≤–∞!');
            log(`üîÑ ${p.name} –±—Ä–æ—Å–∞–µ—Ç –µ—â—ë —Ä–∞–∑ (–¥—É–±–ª—å)`);
            $('#roll').disabled = false;
          } else {
            setTimeout(() => this.nextTurn(), 800);
          }
        }
      });
      
      update();
    },
    
    landOn(idx) {
      const p = this.cur();
      const cell = BOARD[idx];
      clearAnno();
      setActiveCell(idx);
      
      if (cell.type === 'go') {
        anno('üèÅ START', 'info');
      } else if (cell.type === 'jail') {
        anno('üèõÔ∏è –ü—Ä–æ—Å—Ç–æ –≤ –≥–æ—Å—Ç—è—Ö', 'info');
      } else if (cell.type === 'parking') {
        anno('üÖøÔ∏è –ë–µ—Å–ø–ª–∞—Ç–Ω–∞—è –ø–∞—Ä–∫–æ–≤–∫–∞', 'info');
      } else if (cell.type === 'gotojail') {
        p.pos = 10;
        p.jailTurns = 1;
        log(`üöî ${p.name} –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –≤ –¢–Æ–†–¨–ú–£!`, true);
        anno('üöî –í –¢–Æ–†–¨–ú–£!\n\nüí∞ –ó–∞–ø–ª–∞—Ç–∏—Ç—å $50 –∏ –≤—ã–π—Ç–∏\n–∏–ª–∏\n‚è≠Ô∏è –ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å 3 —Ö–æ–¥–∞ (–±–µ—Å–ø–ª–∞—Ç–Ω—ã–π –≤—ã—Ö–æ–¥)', 'rent');
        renderPips();
        setActiveCell(10);
        setTimeout(() => this.nextTurn(), 2000);
        return; // –í–∞–∂–Ω–æ: –≤—ã—Ö–æ–¥–∏–º, –Ω–µ –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º
      } else if (cell.type === 'tax') {
        p.money -= cell.amount;
        log(`üí∏ ${p.name} –∑–∞–ø–ª–∞—Ç–∏–ª –Ω–∞–ª–æ–≥ $${cell.amount}`);
        anno(`üí∏ –ù–∞–ª–æ–≥: -$${cell.amount}`, 'rent');
        update();
      } else if (cell.type === 'chance') {
        anno('‚ùì –°–ª—É—á–∞–π–Ω–æ—Å—Ç—å', 'info');
      } else if (cell.type === 'prop' || cell.type === 'station' || cell.type === 'utility') {
        this.handleProperty(idx);
        // –ï—Å–ª–∏ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å –¥–æ—Å—Ç—É–ø–Ω–∞ –¥–ª—è –ø–æ–∫—É–ø–∫–∏, –ù–ï –ø–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —Ö–æ–¥—É
        // –ò–≥—Ä–æ–∫ –¥–æ–ª–∂–µ–Ω –≤—ã–±—Ä–∞—Ç—å: –∫—É–ø–∏—Ç—å –∏–ª–∏ –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å
        if (!this.owned[idx]) {
          return; // –û–°–¢–ê–ù–ê–í–õ–ò–í–ê–ï–ú–°–Ø - –∂–¥—ë–º —Ä–µ—à–µ–Ω–∏—è –∏–≥—Ä–æ–∫–∞
        }
      }
    },
    
    handleProperty(idx) {
      const p = this.cur();
      const cell = BOARD[idx];
      const st = this.owned[idx];
      
      if (!st) {
        // –°–í–û–ë–û–î–ù–ê–Ø –°–û–ë–°–¢–í–ï–ù–ù–û–°–¢–¨ - –ü–†–ï–î–õ–û–ñ–ò–¢–¨ –ö–£–ü–ò–¢–¨
        anno(`üè† ${cell.name}\n–¶–µ–Ω–∞: $${cell.price}\n\n–í–´–ë–ï–†–ò–¢–ï –î–ï–ô–°–¢–í–ò–ï:`, 'buy');
        $('#buy').disabled = false;
        $('#buy').dataset.index = idx;
        $('#skipBuy').disabled = false;
        $('#roll').disabled = true; // –ë–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É –±—Ä–æ—Å–∫–∞
        
        log(`üè† ${p.name} –º–æ–∂–µ—Ç –∫—É–ø–∏—Ç—å ${cell.name} –∑–∞ $${cell.price}`, true);
        toast(`üè† –ö—É–ø–∏—Ç—å –∏–ª–∏ –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å?`);
        
        // –ù–ï –ü–ï–†–ï–•–û–î–ò–ú –ö –°–õ–ï–î–£–Æ–©–ï–ú–£ –•–û–î–£ - –ñ–î–Å–ú –í–´–ë–û–†–ê!
      } else if (st.owner !== p.id) {
        const owner = this.players[st.owner];
        if (st.mortgaged) {
          anno(`${cell.name}\n–í –∑–∞–ª–æ–≥–µ —É ${owner.name}`, 'info');
          return;
        }
        
        let rent = this.calcRent(idx);
        p.money -= rent;
        owner.money += rent;
        log(`üí∏ ${p.name} –∑–∞–ø–ª–∞—Ç–∏–ª –∞—Ä–µ–Ω–¥—É $${rent} –∏–≥—Ä–æ–∫—É ${owner.name}`, true);
        anno(`üí∏ –ê—Ä–µ–Ω–¥–∞: $${rent}\n–í–ª–∞–¥–µ–ª–µ—Ü: ${owner.name}`, 'rent');
        update();
      } else {
        anno(`‚úÖ –í–∞—à–∞ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å:\n${cell.name}`, 'info');
      }
    },
    
    calcRent(idx) {
      const cell = BOARD[idx];
      const st = this.owned[idx];
      
      if (cell.type === 'station') {
        const owned = Object.values(this.owned).filter(s => 
          s.owner === st.owner && BOARD[s.id]?.type === 'station'
        ).length;
        return 25 * Math.pow(2, owned - 1);
      }
      
      if (cell.type === 'utility') {
        const owned = Object.values(this.owned).filter(s => 
          s.owner === st.owner && BOARD[s.id]?.type === 'utility'
        ).length;
        const mult = owned === 2 ? 10 : 4;
        return (this.dice[0] + this.dice[1]) * mult;
      }
      
      if (st.hotel) return cell.baseRent * 32;
      if (st.houses > 0) return cell.baseRent * Math.pow(2, st.houses);
      
      const sameColor = BOARD.filter(c => c.type === 'prop' && c.color === cell.color);
      const ownsAll = sameColor.every(c => 
        this.owned[c.id]?.owner === st.owner && !this.owned[c.id].mortgaged
      );
      
      return ownsAll ? cell.baseRent * 2 : cell.baseRent;
    },
    
    buy(idx) {
      const p = this.cur();
      const cell = BOARD[idx];
      
      if (p.money < cell.price) {
        toast('‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–µ–Ω–µ–≥!');
        return;
      }
      
      p.money -= cell.price;
      this.owned[idx] = {id: idx, owner: p.id, houses: 0, hotel: false, mortgaged: false};
      log(`‚úÖ ${p.name} –∫—É–ø–∏–ª ${cell.name} –∑–∞ $${cell.price}`, true);
      toast('‚úÖ –ö—É–ø–ª–µ–Ω–æ!');
      clearAnno();
      
      // –°–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏ –ø–æ–∫—É–ø–∫–∏
      $('#buy').disabled = true;
      $('#skipBuy').disabled = true;
      
      update();
      updateOwnershipUI();
      
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º: –±—ã–ª –ª–∏ –¥—É–±–ª—å?
      const wasDouble = this.dice[0] === this.dice[1];
      
      if (wasDouble) {
        // –î—É–±–ª—å - –¥–∞—ë–º –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –±—Ä–æ—Å–∏—Ç—å —Å–Ω–æ–≤–∞
        toast('üé≤ –î—É–±–ª—å! –ë—Ä–æ—Å–∞–π—Ç–µ –∫–æ—Å—Ç–∏ —Å–Ω–æ–≤–∞!');
        $('#roll').disabled = false;
      } else {
        // –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —Å–ª–µ–¥—É—é—â–µ–º—É –∏–≥—Ä–æ–∫—É
        setTimeout(() => this.nextTurn(), 500);
      }
    },
    
    skip() {
      clearAnno();
      log(`‚è≠Ô∏è ${this.cur().name} –ø—Ä–æ–ø—É—Å—Ç–∏–ª –ø–æ–∫—É–ø–∫—É`);
      
      // –°–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏ –ø–æ–∫—É–ø–∫–∏
      $('#buy').disabled = true;
      $('#skipBuy').disabled = true;
      
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º: –±—ã–ª –ª–∏ –¥—É–±–ª—å?
      const wasDouble = this.dice[0] === this.dice[1];
      
      if (wasDouble) {
        // –î—É–±–ª—å - –¥–∞—ë–º –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –±—Ä–æ—Å–∏—Ç—å —Å–Ω–æ–≤–∞
        toast('üé≤ –î—É–±–ª—å! –ë—Ä–æ—Å–∞–π—Ç–µ –∫–æ—Å—Ç–∏ —Å–Ω–æ–≤–∞!');
        $('#roll').disabled = false;
      } else {
        // –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —Å–ª–µ–¥—É—é—â–µ–º—É –∏–≥—Ä–æ–∫—É
        setTimeout(() => this.nextTurn(), 500);
      }
    },
    
    // ========== –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –ú–ï–•–ê–ù–ò–ö–ê –¢–Æ–†–¨–ú–´ ==========
    payBailAndRoll() {
      const p = this.cur();
      
      if (p.jailTurns === 0) {
        toast('‚ùå –í—ã –Ω–µ –≤ —Ç—é—Ä—å–º–µ!');
        return;
      }
      
      if (p.money < 50) {
        toast('‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–µ–Ω–µ–≥! –ù—É–∂–Ω–æ $50.');
        log(`${p.name} –Ω–µ –º–æ–∂–µ—Ç –∑–∞–ø–ª–∞—Ç–∏—Ç—å –∑–∞–ª–æ–≥ - –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–µ–Ω–µ–≥!`, true);
        return;
      }
      
      p.money -= 50;
      p.jailTurns = 0;
      log(`üîì ${p.name} –∑–∞–ø–ª–∞—Ç–∏–ª $50 –∏ –≤—ã—à–µ–ª –∏–∑ —Ç—é—Ä—å–º—ã!`, true);
      toast('üîì –í—ã—Ö–æ–¥ –æ–ø–ª–∞—á–µ–Ω! –ë—Ä–æ—Å–∞–π—Ç–µ –∫–æ—Å—Ç–∏!');
      
      update();
      $('#payBail').disabled = true;
      $('#stayJail').disabled = true;
      $('#roll').disabled = false;
    },
    
    stayJail() {
      const p = this.cur();
      
      if (p.jailTurns === 0) {
        toast('‚ùå –í—ã –Ω–µ –≤ —Ç—é—Ä—å–º–µ!');
        return;
      }
      
      p.jailTurns++;
      log(`‚è≠Ô∏è ${p.name} –ø—Ä–æ–ø—É—Å–∫–∞–µ—Ç —Ö–æ–¥ –≤ —Ç—é—Ä—å–º–µ (${p.jailTurns}/3)`);
      
      // –ü–æ—Å–ª–µ 3 –ø—Ä–æ–ø—É—Å–∫–æ–≤ - –ë–ï–°–ü–õ–ê–¢–ù–´–ô –≤—ã—Ö–æ–¥
      if (p.jailTurns >= 3) {
        p.jailTurns = 0;
        log(`üîì ${p.name} –≤—ã—à–µ–ª –∏–∑ —Ç—é—Ä—å–º—ã –ë–ï–°–ü–õ–ê–¢–ù–û –ø–æ—Å–ª–µ 3 –ø—Ä–æ–ø—É—Å–∫–æ–≤!`, true);
        toast('üîì –í—ã —Å–≤–æ–±–æ–¥–Ω—ã! (3 –ø—Ä–æ–ø—É—Å–∫–∞)');
      } else {
        toast(`‚è≠Ô∏è –•–æ–¥ –ø—Ä–æ–ø—É—â–µ–Ω (${p.jailTurns}/3)`);
      }
      
      update();
      this.nextTurn();
    },
    
    nextTurn() {
      $('#buy').disabled = true;
      $('#skipBuy').disabled = true;
      $('#payBail').disabled = true;
      $('#stayJail').disabled = true;
      $('#roll').disabled = false;
      
      clearAnno();
      this.current = (this.current + 1) % this.players.length;
      
      const p = this.cur();
      updateTurnLabel();
      setActiveCell(p.pos);
      
      if (p.jailTurns > 0) {
        $('#payBail').disabled = false;
        $('#stayJail').disabled = false;
        $('#roll').disabled = true;
        log(`üîí ${p.name} –≤ —Ç—é—Ä—å–º–µ (${p.jailTurns}/3 –ø—Ä–æ–ø—É—Å–∫–∞)`, true);
        toast('üîí –í—ã –≤ —Ç—é—Ä—å–º–µ! –í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ.');
      }
    },
    
    build(idx) {
      const p = this.cur();
      const cell = BOARD[idx];
      const st = this.owned[idx];
      
      if (!st || st.owner !== p.id) return;
      
      const sameColor = BOARD.filter(c => c.type === 'prop' && c.color === cell.color);
      const ownsAll = sameColor.every(c => 
        this.owned[c.id]?.owner === p.id && !this.owned[c.id].mortgaged
      );
      
      if (!ownsAll) {
        toast('‚ùå –ù—É–∂–Ω–∞ –≤—Å—è –≥—Ä—É–ø–ø–∞!');
        return;
      }
      
      const cost = Math.floor(cell.price * 0.5);
      
      if (st.hotel) {
        toast('‚ùå –£–∂–µ –ø–æ—Å—Ç—Ä–æ–µ–Ω –æ—Ç–µ–ª—å!');
        return;
      }
      
      if (st.houses >= 4) {
        if (p.money < cost) {
          toast('‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–µ–Ω–µ–≥!');
          return;
        }
        p.money -= cost;
        st.houses = 0;
        st.hotel = true;
        log(`üè® ${p.name} –ø–æ—Å—Ç—Ä–æ–∏–ª –æ—Ç–µ–ª—å –Ω–∞ ${cell.name}`);
        toast('üè® –û—Ç–µ–ª—å –ø–æ—Å—Ç—Ä–æ–µ–Ω!');
      } else {
        if (p.money < cost) {
          toast('‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–µ–Ω–µ–≥!');
          return;
        }
        p.money -= cost;
        st.houses++;
        log(`üè† ${p.name} –ø–æ—Å—Ç—Ä–æ–∏–ª –¥–æ–º –Ω–∞ ${cell.name} (${st.houses}/4)`);
        toast(`üè† –î–æ–º –ø–æ—Å—Ç—Ä–æ–µ–Ω! (${st.houses}/4)`);
      }
      
      update();
      updateOwnershipUI();
    },
    
    sellHouse(idx) {
      const st = this.owned[idx];
      const cell = BOARD[idx];
      const p = this.cur();
      
      if (!st || st.owner !== p.id) return;
      
      const refund = Math.floor(cell.price * 0.25);
      
      if (st.hotel) {
        st.hotel = false;
        st.houses = 4;
        p.money += refund;
        log(`üí∞ ${p.name} –ø—Ä–æ–¥–∞–ª –æ—Ç–µ–ª—å –Ω–∞ ${cell.name}`);
        toast('üí∞ –û—Ç–µ–ª—å –ø—Ä–æ–¥–∞–Ω!');
      } else if (st.houses > 0) {
        st.houses--;
        p.money += refund;
        log(`üí∞ ${p.name} –ø—Ä–æ–¥–∞–ª –¥–æ–º –Ω–∞ ${cell.name}`);
        toast('üí∞ –î–æ–º –ø—Ä–æ–¥–∞–Ω!');
      }
      
      update();
      updateOwnershipUI();
    },
    
    mortToggle(idx) {
      const st = this.owned[idx];
      const cell = BOARD[idx];
      const p = this.cur();
      
      if (!st || st.owner !== p.id) return;
      
      if (st.houses > 0 || st.hotel) {
        toast('‚ùå –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–¥–∞–π—Ç–µ –ø–æ—Å—Ç—Ä–æ–π–∫–∏!');
        return;
      }
      
      if (st.mortgaged) {
        const cost = Math.floor(cell.price * 0.55);
        if (p.money < cost) {
          toast('‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–µ–Ω–µ–≥!');
          return;
        }
        p.money -= cost;
        st.mortgaged = false;
        log(`üîì ${p.name} –≤—ã–∫—É–ø–∏–ª ${cell.name} –∏–∑ –∑–∞–ª–æ–≥–∞`);
        toast('üîì –í—ã–∫—É–ø –∏–∑ –∑–∞–ª–æ–≥–∞!');
      } else {
        const value = Math.floor(cell.price * 0.5);
        p.money += value;
        st.mortgaged = true;
        log(`üîí ${p.name} –∑–∞–ª–æ–∂–∏–ª ${cell.name}`);
        toast('üîí –í –∑–∞–ª–æ–≥–µ!');
      }
      
      update();
      updateOwnershipUI();
    },
    
    sell(idx) {
      const st = this.owned[idx];
      const cell = BOARD[idx];
      const p = this.cur();
      
      if (!st || st.owner !== p.id) return;
      
      if (st.houses > 0 || st.hotel) {
        toast('‚ùå –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–¥–∞–π—Ç–µ –ø–æ—Å—Ç—Ä–æ–π–∫–∏!');
        return;
      }
      
      const value = st.mortgaged ? 0 : Math.floor(cell.price * 0.5);
      p.money += value;
      delete this.owned[idx];
      log(`üí∞ ${p.name} –ø—Ä–æ–¥–∞–ª ${cell.name} –∑–∞ $${value}`);
      toast('üí∞ –ü—Ä–æ–¥–∞–Ω–æ!');
      
      update();
      updateOwnershipUI();
    },
    
    manageOpen() {
      const p = this.cur();
      const list = $('#assetList');
      list.innerHTML = '';
      
      const assets = Object.values(this.owned).filter(st => st.owner === p.id);
      
      if (assets.length === 0) {
        list.innerHTML = '<p style="text-align:center;color:#94a3b8;padding:20px">–£ –≤–∞—Å –Ω–µ—Ç —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏</p>';
      } else {
        assets.forEach(st => {
          const cell = BOARD[st.id];
          const el = document.createElement('div');
          el.className = 'item';
          
          let status = '';
          if (st.hotel) status = 'üè® –û—Ç–µ–ª—å';
          else if (st.houses > 0) status = `üè† ${st.houses} –¥–æ–º(–∞)`;
          else if (st.mortgaged) status = 'üîí –í –∑–∞–ª–æ–≥–µ';
          
          el.innerHTML = `
            <div><strong>${cell.name}</strong><br><small style="color:#94a3b8">${status || '–ü—É—Å—Ç–æ'}</small></div>
            <div style="display:flex;gap:6px;flex-wrap:wrap">
              ${!st.mortgaged && cell.type === 'prop' ? `<button data-i="${st.id}" data-a="build">üèóÔ∏è –°—Ç—Ä–æ–∏—Ç—å</button>` : ''}
              ${(st.houses > 0 || st.hotel) ? `<button data-i="${st.id}" data-a="sellhouse">üíµ –ü—Ä–æ–¥–∞—Ç—å</button>` : ''}
              ${st.houses === 0 && !st.hotel ? `<button data-i="${st.id}" data-a="mort">${st.mortgaged ? 'üîì –í—ã–∫—É–ø' : 'üîí –ó–∞–ª–æ–≥'}</button>` : ''}
              ${st.houses === 0 && !st.hotel ? `<button data-i="${st.id}" data-a="sell" style="background:#dc2626;border-color:#dc2626">üóëÔ∏è –ü—Ä–æ–¥–∞—Ç—å</button>` : ''}
            </div>
          `;
          
          list.appendChild(el);
        });
      }
      
      $('#manageDlg').classList.add('show');
    }
  };

  // ---------- –†–ï–ù–î–ï–† ----------
  const $ = s => document.querySelector(s);
  const $$ = s => document.querySelectorAll(s);

  function indexToGrid(i) {
    if (i >= 0 && i <= 9) return {row: 10, col: 10 - i};
    if (i >= 10 && i <= 19) return {row: 20 - i, col: 0};
    if (i >= 20 && i <= 29) return {row: 0, col: i - 20};
    if (i >= 30 && i <= 39) return {row: i - 30, col: 10};
    return {row: 0, col: 0};
  }

  function renderBoard() {
    const board = $('#board');
    const center = document.createElement('div');
    center.className = 'center';
    center.innerHTML = `
      <div class="dice-wrap">
        <div class="die" id="die1">1</div>
        <div class="die" id="die2">1</div>
      </div>
    `;
    board.appendChild(center);
    
    BOARD.forEach((cell, i) => {
      const pos = indexToGrid(i);
      const el = document.createElement('div');
      el.className = 'cell';
      el.dataset.index = i;
      el.style.gridRow = pos.row + 1;
      el.style.gridColumn = pos.col + 1;
      
      let html = `<div>${cell.name}</div>`;
      if (cell.price) html += `<div class="price">$${cell.price}</div>`;
      
      el.innerHTML = html;
      board.appendChild(el);
    });
  }

  function updateOwnershipUI() {
    $$('.owner-tag').forEach(t => t.remove());
    
    Object.entries(Game.owned).forEach(([idx, st]) => {
      const cell = $(`.cell[data-index="${idx}"]`);
      if (!cell) return;
      
      const tag = document.createElement('div');
      tag.className = 'owner-tag';
      tag.style.background = getPlayerColor(st.owner);
      if (st.mortgaged) tag.style.opacity = '0.4';
      cell.appendChild(tag);
    });
  }

  function getPlayerColor(pid) {
    const colors = ['#ef4444', '#3b82f6', '#22c55e', '#f59e0b'];
    return colors[pid % colors.length];
  }

  function log(msg, important = false) {
    const l = $('#log');
    const p = document.createElement('p');
    if (important) p.className = 'important';
    p.textContent = msg;
    l.appendChild(p);
    l.scrollTop = l.scrollHeight;
  }

  function toast(msg) {
    const t = $('#toast');
    t.textContent = msg;
    t.classList.add('show');
    setTimeout(() => t.classList.remove('show'), 2500);
  }

  function anno(msg, type = 'info') {
    const a = $('#anno');
    a.innerHTML = `<div class="msg ${type}">${msg}</div>`;
    a.style.display = 'block';
  }

  function clearAnno() {
    $('#anno').style.display = 'none';
  }

  function renderTurnHUD() {
    const hud = $('#turnHud');
    const p = Game.cur();
    hud.querySelector('.swatch').style.background = getPlayerColor(p.id);
    hud.querySelector('#turnHudName').textContent = p.name;
  }

  // ========== –£–õ–£–ß–®–ï–ù–ù–ê–Ø –ê–ù–ò–ú–ê–¶–ò–Ø –î–í–ò–ñ–ï–ù–ò–Ø ==========
  function renderPips() {
    $$('.cell').forEach(cell => cell.querySelectorAll('.pips').forEach(n => n.remove()));
    const map = new Map();
    Game.players.forEach(p => {
      const a = map.get(p.pos) || [];
      a.push(p);
      map.set(p.pos, a);
    });
    
    map.forEach((arr, idx) => {
      const cell = $(`.cell[data-index="${idx}"]`);
      if (!cell) return;
      const wrap = document.createElement('div');
      wrap.className = 'pips';
      arr.forEach(p => {
        const dot = document.createElement('div');
        dot.className = 'pip';
        dot.id = `pip-${p.id}`;
        dot.style.background = getPlayerColor(p.id);
        wrap.appendChild(dot);
      });
      cell.appendChild(wrap);
    });
  }

  // –ü–û–®–ê–ì–û–í–ê–Ø –ê–ù–ò–ú–ê–¶–ò–Ø - –í–ò–î–ù–û –ö–ê–ö –§–ò–®–ö–ê –î–í–ò–ñ–ï–¢–°–Ø –ü–û –ö–õ–ï–¢–ö–ê–ú
  function animateMove(pid, from, to, done) {
    const steps = ((to - from) + 40) % 40;
    let i = 0;
    
    const step = () => {
      const p = Game.players[pid];
      const currentPos = (from + i) % 40;
      p.pos = currentPos;
      
      // –û—á–∏—â–∞–µ–º –ø–æ–¥—Å–≤–µ—Ç–∫—É "–ø—Ä–æ—Ö–æ–¥—è—â–∏—Ö" –∫–ª–µ—Ç–æ–∫
      $$('.cell').forEach(c => c.classList.remove('moving-through'));
      
      // –ü–æ–¥—Å–≤–µ—á–∏–≤–∞–µ–º —Ç–µ–∫—É—â—É—é –∫–ª–µ—Ç–∫—É
      const currentCell = $(`.cell[data-index="${currentPos}"]`);
      if (currentCell) {
        currentCell.classList.add('moving-through');
      }
      
      renderPips();
      setActiveCell(currentPos);
      
      // –î–æ–±–∞–≤–ª—è–µ–º –∞–Ω–∏–º–∞—Ü–∏—é –∫ —Ñ–∏—à–∫–µ
      const pip = $(`#pip-${pid}`);
      if (pip) {
        pip.classList.add('moving');
        setTimeout(() => pip.classList.remove('moving'), 300);
      }
      
      if (i++ < steps) {
        requestAnimationFrame(() => {
          setTimeout(step, 120); // 120ms –º–µ–∂–¥—É —à–∞–≥–∞–º–∏ - –≤–∏–¥–Ω–æ –¥–≤–∏–∂–µ–Ω–∏–µ
        });
      } else {
        p.pos = to;
        renderPips();
        // –£–±–∏—Ä–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—É—é –ø–æ–¥—Å–≤–µ—Ç–∫—É
        $$('.cell').forEach(c => c.classList.remove('moving-through'));
        if (typeof done === 'function') done();
      }
    };
    
    step();
  }

  function renderPlayers() {
    const wrap = $('#players');
    wrap.innerHTML = '';
    
    Game.players.forEach((p, idx) => {
      const el = document.createElement('div');
      el.className = 'player' + (idx === Game.current ? ' you' : '');
      if (p.jailTurns > 0) el.classList.add('in-jail');
      
      const color = getPlayerColor(p.id);
      
      el.innerHTML = `
        <div class="id">
          <span class="swatch" style="background:${color}"></span>
          <strong>${p.name}</strong>
          ${p.jailTurns > 0 ? `<span class="jail-badge">üîí ${p.jailTurns}/3</span>` : ''}
        </div>
        <div class="money">$${p.money}</div>
      `;
      
      wrap.appendChild(el);
    });
  }

  function updateTurnLabel() {
    const lbl = $('#turnLabel');
    if (lbl) lbl.textContent = `–•–æ–¥: ${Game.cur().name}`;
    renderPlayers();
    renderTurnHUD();
  }

  function setActiveCell(i) {
    $$('.cell').forEach(c => {
      c.classList.remove('active');
      c.style.boxShadow = '';
    });
    
    const c = $(`.cell[data-index="${i}"]`);
    if (c) {
      const color = getPlayerColor(Game.current);
      c.classList.add('active');
      c.style.boxShadow = `0 0 0 3px ${color} inset`;
    }
  }

  function update() {
    renderPlayers();
    renderPips();
    updateOwnershipUI();
  }

  function save() {
    localStorage.setItem('mono.save', JSON.stringify({
      players: Game.players,
      current: Game.current,
      owned: Game.owned,
      dice: Game.dice
    }));
  }

  function load() {
    const raw = localStorage.getItem('mono.save');
    if (!raw) return false;
    try {
      const s = JSON.parse(raw);
      Object.assign(Game, s);
      return true;
    } catch (e) {
      return false;
    }
  }

  function clearSave() {
    localStorage.removeItem('mono.save');
  }

  // ---------- –ö–ù–û–ü–ö–ò ----------
  $('#newGame').addEventListener('click', () => {
    const hasOwned = Object.keys(Game.owned || {}).length > 0;
    const moved = (Game.players || []).some(p => p.pos > 0);
    if (hasOwned || moved) {
      if (!confirm('–ù–∞—á–∞—Ç—å –Ω–æ–≤—É—é –∏–≥—Ä—É? –¢–µ–∫—É—â–∞—è –ø–∞—Ä—Ç–∏—è –±—É–¥–µ—Ç —Å–±—Ä–æ—à–µ–Ω–∞.')) return;
    }
    showSetup();
  });
  
  $('#roll').addEventListener('click', () => Game.roll());
  $('#payBail').addEventListener('click', () => Game.payBailAndRoll());
  $('#stayJail').addEventListener('click', () => Game.stayJail());
  
  $('#buy').addEventListener('click', e => {
    const idx = Number(e.currentTarget.dataset.index);
    if (Number.isFinite(idx)) Game.buy(idx);
    e.currentTarget.disabled = true;
    $('#skipBuy').disabled = true;
  });
  
  $('#skipBuy').addEventListener('click', () => {
    Game.skip();
    $('#buy').disabled = true;
    $('#skipBuy').disabled = true;
  });
  
  $('#manage').addEventListener('click', () => Game.manageOpen());
  
  $('#help').addEventListener('click', () => {
    alert(`üìñ –ü–†–ê–í–ò–õ–ê –ú–û–ù–û–ü–û–õ–ò–ò

üé≤ –ö–û–°–¢–ò: –ë—Ä–æ—Å–∞–π—Ç–µ –∫–æ—Å—Ç–∏ –∏ –¥–≤–∏–≥–∞–π—Ç–µ—Å—å –ø–æ –∫–ª–µ—Ç–∫–∞–º

üè† –ü–û–ö–£–ü–ö–ê: –ü–æ–∫—É–ø–∞–π—Ç–µ —É–ª–∏—Ü—ã –∏ —Å—Ç—Ä–æ–π—Ç–µ –¥–æ–º–∞/–æ—Ç–µ–ª–∏

üí∞ –ê–†–ï–ù–î–ê: –ü–ª–∞—Ç–∏—Ç–µ –∞—Ä–µ–Ω–¥—É –≤–ª–∞–¥–µ–ª—å—Ü–∞–º —É–ª–∏—Ü

üîí –¢–Æ–†–¨–ú–ê (–ò–°–ü–†–ê–í–õ–ï–ù–û!):
  ‚Ä¢ –í–∞—Ä–∏–∞–Ω—Ç 1: –ó–∞–ø–ª–∞—Ç–∏—Ç—å $50 ‚Üí –°—Ä–∞–∑—É –≤—ã—Ö–æ–¥–∏—Ç–µ –∏ –±—Ä–æ—Å–∞–µ—Ç–µ –∫–æ—Å—Ç–∏
  ‚Ä¢ –í–∞—Ä–∏–∞–Ω—Ç 2: –ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å 3 —Ö–æ–¥–∞ ‚Üí –í—ã—Ö–æ–¥ –ë–ï–°–ü–õ–ê–¢–ù–´–ô

üé≤ –î–£–ë–õ–¨: –ü—Ä–∏ –≤—ã–ø–∞–¥–µ–Ω–∏–∏ –¥—É–±–ª—è –±—Ä–æ—Å–∞–π—Ç–µ –∫–æ—Å—Ç–∏ –µ—â—ë —Ä–∞–∑!

üíé –ú–û–ù–û–ü–û–õ–ò–Ø: –í–ª–∞–¥–µ–Ω–∏–µ –≤—Å–µ–π –≥—Ä—É–ø–ø–æ–π —Ü–≤–µ—Ç–∞ —É–¥–≤–∞–∏–≤–∞–µ—Ç –∞—Ä–µ–Ω–¥—É

üèóÔ∏è –°–¢–†–û–ò–¢–ï–õ–¨–°–¢–í–û:
  ‚Ä¢ 4 –¥–æ–º–∞ = 1 –æ—Ç–µ–ª—å
  ‚Ä¢ –ú–æ–∂–Ω–æ —Å—Ç—Ä–æ–∏—Ç—å —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –º–æ–Ω–æ–ø–æ–ª–∏–∏

üíµ –ó–ê–õ–û–ì: 50% –æ—Ç —Ü–µ–Ω—ã, –≤—ã–∫—É–ø 55%`);
  });
  
  $('#save').addEventListener('click', () => {
    save();
    toast('üíæ –ò–≥—Ä–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞!');
  });

  // SETUP
  function showSetup() {
    clearAnno();
    const o = $('#setup');
    const n = $('#names');
    const pCount = $('#pCount');
    const startMoney = $('#startMoney');
    
    const rebuild = () => {
      n.innerHTML = '';
      const cnt = Math.min(4, Math.max(2, Number(pCount.value || 2)));
      
      for (let i = 0; i < cnt; i++) {
        const f = document.createElement('div');
        f.className = 'field';
        f.innerHTML = `<label>–ò–º—è –∏–≥—Ä–æ–∫–∞ ${i + 1}</label><input type="text" id="pName${i}" value="–ò–≥—Ä–æ–∫ ${i + 1}"/>`;
        n.appendChild(f);
      }
    };
    
    pCount.addEventListener('input', rebuild, {once: true});
    rebuild();
    o.classList.add('show');
    
    $('#startGame').onclick = () => {
      const cnt = Math.min(4, Math.max(2, Number(pCount.value || 2)));
      const names = [];
      
      for (let i = 0; i < cnt; i++) {
        names.push(String(document.getElementById('pName' + i).value || `–ò–≥—Ä–æ–∫ ${i + 1}`));
      }
      
      o.classList.remove('show');
      clearSave();
      Game.initFromConfig({names, money: Math.max(500, Number(startMoney.value || 1500))});
    };
    
    $('#cancelSetup').onclick = () => {
      o.classList.remove('show');
    };
  }

  // MANAGE DIALOG
  $('#assetList').addEventListener('click', e => {
    const btn = e.target.closest('button');
    if (!btn) return;
    
    const i = Number(btn.dataset.i);
    const a = btn.dataset.a;
    
    if (a === 'build') Game.build(i);
    if (a === 'sellhouse') Game.sellHouse(i);
    if (a === 'mort') Game.mortToggle(i);
    if (a === 'sell') Game.sell(i);
    
    Game.manageOpen();
    updateOwnershipUI();
  });
  
  $('#closeManage').addEventListener('click', () => $('#manageDlg').classList.remove('show'));

  $('#qbManage')?.addEventListener('click', () => Game.manageOpen());
  $('#qbMortgage')?.addEventListener('click', () => Game.manageOpen());
  $('#qbSell')?.addEventListener('click', () => Game.manageOpen());

  // ---------- –°–¢–ê–†–¢ ----------
  document.addEventListener('DOMContentLoaded', () => {
    renderBoard();
    clearAnno();
    
    if (!load()) {
      showSetup();
    } else {
      renderPlayers();
      renderPips();
      updateTurnLabel();
      setActiveCell(Game.cur().pos);
      
      if (Game.cur().jailTurns > 0) {
        $('#payBail').disabled = false;
        $('#stayJail').disabled = false;
        $('#roll').disabled = true;
      }
    }
  });

  function showDice(d1, d2) {
    const a = $('#die1');
    const b = $('#die2');
    [a, b].forEach(el => {
      el.classList.add('shake');
      setTimeout(() => el.classList.remove('shake'), 500);
    });
    a.textContent = d1;
    b.textContent = d2;
  }
  </script>
</body>
</html>
